name: docs build

on:
  push:
    branches:
      # è§¦å‘æ¡ä»¶ï¼šä»…åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
      - main

jobs:
  LearnData-build:
    runs-on: ubuntu-latest
    env:
      # ä» GitHub Secrets ä¸­è·å– FTP ç›¸å…³çš„ç¯å¢ƒå˜é‡
      FTP_HOST: ${{ secrets.ftp_host }}

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç ä»“åº“
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          # è·å–æ‰€æœ‰æ ‡è®°å’Œåˆ†æ”¯çš„å®Œæ•´å†å²è®°å½•ï¼Œç¡®ä¿å¯ä»¥è¿½æº¯å†å²
          fetch-depth: 0

      # æ­¥éª¤ 2ï¼šå®‰è£… pnpm åŒ…ç®¡ç†å™¨
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9  # æŒ‡å®šå®‰è£… pnpm ç‰ˆæœ¬
          run_install: true  # å®‰è£…é¡¹ç›®çš„ä¾èµ–

      # æ­¥éª¤ 3ï¼šå®‰è£… Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20  # æŒ‡å®š Node.js ç‰ˆæœ¬
          cache: pnpm  # ä½¿ç”¨ pnpm ä½œä¸ºç¼“å­˜æœºåˆ¶ï¼ŒåŠ é€Ÿä¾èµ–å®‰è£…

      # æ­¥éª¤ 4ï¼šå®‰è£…é¡¹ç›®ä¾èµ–ï¼ŒåŒ…æ‹¬ Waline å®¢æˆ·ç«¯
      - name: Install dependencies
        run: |
          pnpm add @waline/client  # å®‰è£… Waline ä¾èµ–
          pnpm install  # å®‰è£…å…¶ä»–é¡¹ç›®ä¾èµ–

      # æ­¥éª¤ 5ï¼šæ„å»ºæ–‡æ¡£
      - name: Build Docs
        env:
          NODE_OPTIONS: --max_old_space_size=8192  # å¢åŠ  Node.js è¿è¡Œå†…å­˜ï¼Œé˜²æ­¢æ„å»ºæ—¶å†…å­˜ä¸è¶³
        run: |-
          # å¤åˆ¶è¯»ä¹¦ç¬”è®°åˆ°å…¬å…±æ–‡ä»¶å¤¹ä¸­
          pnpm cpx "docs/reading/**" docs/.vuepress/public/reading
          # æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼Œç”Ÿæˆé™æ€æ–‡ä»¶
          pnpm run docs:build
          # é˜²æ­¢ GitHub Pages ä½¿ç”¨ Jekyll æ¥å¤„ç†é™æ€é¡µé¢
          > docs/.vuepress/dist/.nojekyll

      # æ­¥éª¤ 6ï¼šéƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages  # å°†æ„å»ºç”Ÿæˆçš„é™æ€æ–‡ä»¶æ¨é€åˆ° gh-pages åˆ†æ”¯
          folder: docs/.vuepress/dist  # é™æ€æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•

      # æ­¥éª¤ 7ï¼šå¦‚æœ FTP é…ç½®å­˜åœ¨ï¼Œå°†æ–‡ä»¶åŒæ­¥åˆ° FTP æœåŠ¡å™¨
      - name: ğŸ“‚ Sync files
        if: env.FTP_HOST != ''  # åªæœ‰å½“ FTP_HOST ä¸ä¸ºç©ºæ—¶æ‰æ‰§è¡Œ
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          local-dir: docs/.vuepress/dist/  # æŒ‡å®šæœ¬åœ°éœ€è¦ä¸Šä¼ çš„ç›®å½•
          server: ${{ secrets.ftp_host }}  # FTP æœåŠ¡å™¨åœ°å€
          username: ${{ secrets.ftp_username }}  # FTP ç”¨æˆ·å
          password: ${{ secrets.ftp_password }}  # FTP å¯†ç 
          port: ${{ secrets.ftp_port }}  # FTP ç«¯å£ï¼Œå»ºè®®ä¿®æ”¹é»˜è®¤çš„21ç«¯å£
          timeout: 600000  # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º600ç§’ï¼ˆ10åˆ†é’Ÿï¼‰
